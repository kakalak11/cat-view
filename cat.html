<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Viewer</title>

    <style>
        main {
            box-sizing: content-box;
            align-content: center;
            text-align: center;
            max-width: 80vw;
            margin: auto;
        }

        header {
            height: 15vh;
            margin: 10px;
        }

        .display {
            height: 70vh;
        }

        .display>img {
            height: 100%;
            object-fit: contain;
        }

        footer {
            margin: 20px auto 20px auto;
        }

        .navigation>button {
            margin-left: 20px;
            margin-right: 20px;
        }

        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            /* Could be more or less, depending on screen size */
            box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.2), 0 4px 20px 0 rgba(0, 0, 0, 0.19);
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content>section>h3 {
            text-align: center;
        }

        .modal-content>section {
            padding: 20px 150px 20px 150px;
        }
    </style>
</head>

<body>
    <main>
        <header>
            <h1>View cat for peace of mind</h1>
            <p>This is a front-end for cat API</p>
            <div>Try yours here &#128073; <a href="https://thecatapi.com/">https://thecatapi.com/</a></div>
        </header>

        <div class="display">
            <img id="cat-image" alt="A cat">
        </div>

        <footer class="navigation">
            <button onclick="prevImage()">
                Prev Cat
            </button>
            <button onclick="randomImageCache()">
                Random Cache
            </button>
            <button onclick="fetchNewImage()">
                New Cat
            </button>
            <button onclick="saveImage()">
                Save cat
            </button>
            <button id="myBtn">
                Open Saved
            </button>
            <button onclick="nextImage()">
                Next Cat
            </button>
        </footer>
    </main>

    <!-- The Modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <section>
                <h3>Your favorite cats</h3>
                <ul id="favorite-list">
                </ul>
            </section>
        </div>

    </div>
</body>

<script>
    const API_KEY = "live_xZjBI0DsGYFT7iYVbmdmtoT8AIW0xd2AWLQYXW9Ua0dDqMYA5Ucue761hsXWdVIT";
    const headers = { 'x-api-key': API_KEY };
    const baseUrl = "https://api.thecatapi.com/v1";
    const storageKey = "favoriteCats";
    const _localStorage = window.localStorage;
    let fetchData = [];
    let currentPage = 0;
    const imgDiv = document.getElementById('cat-image');
    const modal = document.getElementById("myModal");
    const btn = document.getElementById("myBtn");
    const span = document.getElementsByClassName("close")[0];

    fetch(`${baseUrl}/images/search?limit=10&breed_ids=beng`, headers)
        .then((response) => response.json())
        .then(data => {
            fetchData = fetchData.concat(data);

            randomImageCache();
        });

    function randomImageCache() {
        if (fetchData) {
            const randIndex = Math.floor(Math.random() * fetchData.length);

            if (fetchData[randIndex] && fetchData[randIndex].url) {
                imgDiv.src = fetchData[randIndex].url;
                currentPage = randIndex;
            }
        }
    }

    function fetchNewImage(id) {
        fetch(`${baseUrl}/images/${id ? id : "search"}`, headers)
            .then((response) => response.json())
            .then(data => {
                if (data.length > 0) {
                    data = data.pop();
                }
                if (data && data.url) {
                    imgDiv.src = data.url;
                    fetchData = fetchData.concat(data);
                    currentPage = fetchData.length - 1;
                }
            })
            .catch(err => {
                throw new Error(err)
            });
    }

    function nextImage() {
        currentPage++
        if (currentPage >= fetchData.length) {
            currentPage = 0;
        }

        if (fetchData[currentPage] && fetchData[currentPage].url) {
            imgDiv.src = fetchData[currentPage].url;
        }
    }

    function prevImage() {
        currentPage--;
        if (currentPage < 0) {
            currentPage = fetchData.length - 1;
        }

        if (fetchData[currentPage] && fetchData[currentPage].url) {
            imgDiv.src = fetchData[currentPage].url;
        }
    }

    function saveImage() {
        const id = fetchData[currentPage].id;
        if (_localStorage) {
            let favCats = _localStorage.getItem(storageKey);
            if (favCats) {
                favCats = JSON.parse((favCats))
                if (favCats.findIndex(favId => id === favId) === -1) {
                    favCats = favCats.concat(id);
                }
                _localStorage.setItem(storageKey, JSON.stringify(favCats));
            } else {
                _localStorage.setItem(storageKey, JSON.stringify([id]));
            }
        }
        syncSavedCats();
    }

    function getSavedImages() {
        let data = []
        if (_localStorage) {
            data = _localStorage.getItem(storageKey);
            if (data) {
                data = JSON.parse(data);
            }
        }
        return data;
    }



    // When the user clicks on the button, open the modal
    btn.onclick = function () {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    let favListEl = document.getElementById("favorite-list");

    function addListElement(content) {
        const newDiv = document.createElement("li");
        const newContent = document.createTextNode(content);
        newDiv.appendChild(newContent);
        newDiv.setAttribute("style", "margin: 10px");

        const newButton = document.createElement("button");
        newButton.setAttribute("style", "margin-left: 10px; float: right");
        const btnContent = document.createTextNode("Show");
        newButton.appendChild(btnContent);

        const delButton = document.createElement("button");
        delButton.setAttribute("style", "margin-left: 10px; float: right");
        const delBtnContent = document.createTextNode("Delete");
        delButton.appendChild(delBtnContent);

        newDiv.appendChild(newButton);
        newDiv.appendChild(delButton);
        newButton.onclick = handleSaveImageClick.bind(this, content);
        delButton.onclick = handleRemoveImageClick.bind(this, content);
        favListEl.appendChild(newDiv);
    }

    function syncSavedCats() {
        const savedImages = getSavedImages();
        favListEl.innerHTML = '';

        if (savedImages.length > 0) {
            savedImages.forEach((id) => {
                addListElement(id);
            })
        } else {
            addListElement("You have no favorite cat yet !");
        }
    }

    function handleSaveImageClick(id) {
        fetchNewImage(id);
        modal.style.display = "none";
    }

    function handleRemoveImageClick(id) {
        if (_localStorage) {
            let favCats = _localStorage.getItem(storageKey);
            if (favCats) {
                favCats = JSON.parse((favCats))
                const imageIndex = favCats.findIndex(favId => id === favId);
                if (imageIndex > -1) {
                    favCats.splice(imageIndex, 1);
                    _localStorage.setItem(storageKey, JSON.stringify(favCats));
                    syncSavedCats();
                }
            }
        }
    }

    syncSavedCats();

</script>

</html>